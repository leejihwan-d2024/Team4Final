CREATE TABLE board (
    id NUMBER(11) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 순번
    code NUMBER(11) NOT NULL, -- 게시물 구분 코드
    title NVARCHAR2(1000) NOT NULL, -- 제목
    content CLOB, -- 내용
    start_date date default null, -- 시작일
    end_date date default null, -- 종료일
    reg_id VARCHAR2(30) NOT NULL, -- 등록 id
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 등록일
    mod_id VARCHAR2(30), -- 수정 id
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- 수정일
);

CREATE TABLE upload_file (
    id NUMBER(20) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 파일 id
    file_target VARCHAR2(20) NOT NULL, -- 파일 대상
    file_name VARCHAR2(1000), -- 파일명
    save_file_name VARCHAR2(255) NOT NULL, -- 저장된 파일명
    file_path VARCHAR2(255), -- full 파일경로
    file_dir VARCHAR2(255), -- 파일경로
    content_type VARCHAR2(100), -- 파일 타입
    file_size NUMBER(20), -- 파일 크기
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- 등록일
);


CREATE TABLE file_map (
    id NUMBER(20) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- id
    board_id NUMBER(20) NOT NULL, -- 게시물 id
    file_id NUMBER(20) NOT NULL, -- 파일 id
    CONSTRAINT fk_board_id FOREIGN KEY (board_id) REFERENCES board(id), -- 외래키 제약조건
    CONSTRAINT fk_upload_file_id FOREIGN KEY (file_id) REFERENCES upload_file(id) -- 외래키 제약조건
);


CREATE TABLE MENU (
    seq         NUMBER(10)                          -- 정렬순서
    , role_user   NUMBER(1) DEFAULT 0                 -- USER 권한 (bit 대체)
    , role_admin  NUMBER(1) DEFAULT 0                 -- ADMIN 권한
    , id          NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY              -- unsigned int -> NUMBER(10)
    , depth       NUMBER(10) DEFAULT 0 NOT NULL       -- Menu depth
    , role_id     NUMBER(10) DEFAULT 0 NOT NULL       -- 메뉴권한
    , menu_icon   VARCHAR2(255)                       -- 메뉴 아이콘
    , menu_link   VARCHAR2(255)                       -- 메뉴 링크
    , menu_name   VARCHAR2(255) NOT NULL              -- 메뉴 명
    , parent_id   NUMBER(10) DEFAULT NULL             -- 부모 메뉴 id
    , is_active   NUMBER(1) DEFAULT 0 NOT NULL        -- 사용여부
    , role_system NUMBER(1) DEFAULT 0                 -- System 권한
);

COMMENT ON TABLE MENU IS '메뉴';
COMMENT ON COLUMN MENU.seq IS '정렬순서';
COMMENT ON COLUMN MENU.role_user IS 'USER 권한';
COMMENT ON COLUMN MENU.role_admin IS 'ADMIN 권한';
COMMENT ON COLUMN MENU.id IS 'Primary key';
COMMENT ON COLUMN MENU.depth IS 'Menu depth';
COMMENT ON COLUMN MENU.role_id IS '메뉴권한';
COMMENT ON COLUMN MENU.menu_icon IS '메뉴 아이콘';
COMMENT ON COLUMN MENU.menu_link IS '메뉴 링크';
COMMENT ON COLUMN MENU.menu_name IS '메뉴 명';
COMMENT ON COLUMN MENU.parent_id IS '부모 메뉴 id';
COMMENT ON COLUMN MENU.is_active IS '사용여부';
COMMENT ON COLUMN MENU.role_system IS 'System 권한';

-- WebAuthn 자격 증명 테이블
CREATE TABLE WEBAUTHN_CREDENTIALS (
    CREDENTIAL_ID VARCHAR2(255) PRIMARY KEY,
    USER_ID VARCHAR2(50) NOT NULL,
    PUBLIC_KEY CLOB NOT NULL,
    ATTESTATION_OBJECT CLOB,
    CLIENT_DATA_JSON CLOB,
    AUTHENTICATOR_DATA CLOB,
    SIGNATURE CLOB,
    USER_HANDLE VARCHAR2(255),
    TYPE VARCHAR2(50),
    CREATED_AT DATE DEFAULT SYSDATE,
    LAST_USED_AT DATE DEFAULT SYSDATE,
    SIGN_COUNT NUMBER DEFAULT 0,
    ACTIVE NUMBER(1) DEFAULT 1
);

-- 로그인 이력 테이블
CREATE TABLE LOGIN_HISTORY (
    ID NUMBER PRIMARY KEY,
    USER_ID VARCHAR2(50) NOT NULL,
    LOGIN_IP VARCHAR2(45),
    USER_AGENT VARCHAR2(500),
    LOGIN_STATUS VARCHAR2(20),
    FAIL_REASON VARCHAR2(200),
    LOGIN_TIME DATE DEFAULT SYSDATE,
    SESSION_ID VARCHAR2(255),
    DEVICE_TYPE VARCHAR2(20),
    LOCATION VARCHAR2(100)
);

-- 사용자 세션 테이블
CREATE TABLE USER_SESSIONS (
    SESSION_ID VARCHAR2(255) PRIMARY KEY,
    USER_ID VARCHAR2(50) NOT NULL,
    USER_IP VARCHAR2(45),
    USER_AGENT VARCHAR2(500),
    LOGIN_TIME DATE DEFAULT SYSDATE,
    LAST_ACCESS_TIME DATE DEFAULT SYSDATE,
    EXPIRE_TIME DATE,
    ACTIVE NUMBER(1) DEFAULT 1,
    DEVICE_INFO VARCHAR2(200),
    LOCATION VARCHAR2(100)
);

-- ROLE 테이블
CREATE TABLE ROLE (
    ROLE_ID NUMBER(19,0) PRIMARY KEY,
    ROLE_NAME VARCHAR2(255 CHAR) NOT NULL
);

-- USERS 테이블 (UserVO와 매핑)
CREATE TABLE USERS (
    USER_ID VARCHAR2(50) PRIMARY KEY,
    USER_PW VARCHAR2(255) NOT NULL,
    USER_NN VARCHAR2(100),
    USER_EMAIL VARCHAR2(255) UNIQUE,
    USER_PHONENO VARCHAR2(20),
    USER_STATUS NUMBER(1) DEFAULT 1,
    USER_SIGN_UP DATE DEFAULT SYSDATE,
    USER_LAST_LOGIN DATE DEFAULT SYSDATE,
    USER_PROFILE_IMAGE_URL VARCHAR2(500),
    USER_POINT NUMBER(10) DEFAULT 0,
    USER_ACTIVE_POINT NUMBER(10) DEFAULT 0
);

--  시퀀스 생성 (자동 증가용)
CREATE SEQUENCE ISEQ$$_81727 START WITH 1 INCREMENT BY 1;

--  기본 권한 데이터 삽입
    INSERT INTO ROLE (ROLE_ID, ROLE_NAME) VALUES (ISEQ$$_81727.NEXTVAL, 'ROLE_USER');
    INSERT INTO ROLE (ROLE_ID, ROLE_NAME) VALUES (ISEQ$$_81727.NEXTVAL, 'ROLE_ADMIN');
    INSERT INTO ROLE (ROLE_ID, ROLE_NAME) VALUES (ISEQ$$_81727.NEXTVAL, 'ROLE_SYSTEM');

-- 사용자 권한 매핑 테이블
CREATE TABLE USER_AUTHORITY (
    USER_ID NUMBER(20) NOT NULL,
    ROLE_ID NUMBER(20) NOT NULL,
    PRIMARY KEY (USER_ID, ROLE_ID),
    CONSTRAINT FK_USER_AUTHORITY_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID),
    CONSTRAINT FK_USER_AUTHORITY_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLE(ROLE_ID)
);

-- 리프레시 토큰 테이블
CREATE TABLE REFRESH_TOKEN (
    ID NUMBER(20) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TOKEN VARCHAR2(255) UNIQUE NOT NULL,
    USER_DEVICE_ID NUMBER(20) NOT NULL,
    EXPIRY_DATE TIMESTAMP NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 사용자 장치 테이블
CREATE TABLE USER_DEVICE (
    ID NUMBER(20) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER(20) NOT NULL,
    DEVICE_ID VARCHAR2(255) NOT NULL,
    DEVICE_TYPE VARCHAR2(20),
    NOTIFICATION_TOKEN VARCHAR2(255),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_USER_DEVICE_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
);

-- 리프레시 토큰과 사용자 장치 연결
ALTER TABLE REFRESH_TOKEN ADD CONSTRAINT FK_REFRESH_TOKEN_USER_DEVICE 
    FOREIGN KEY (USER_DEVICE_ID) REFERENCES USER_DEVICE(ID);