-- Oracle용 카카오 로그인을 위한 컬럼 추가
-- 기존 USERS 테이블에 카카오 관련 컬럼 추가

-- KAKAO_ID 컬럼 추가 (VARCHAR2(255))
ALTER TABLE USERS ADD KAKAO_ID VARCHAR2(255) UNIQUE;

-- PROVIDER 컬럼 추가 (VARCHAR2(50))
ALTER TABLE USERS ADD PROVIDER VARCHAR2(50);

-- 인덱스 추가
CREATE INDEX idx_users_kakao_id ON USERS(KAKAO_ID);
CREATE INDEX idx_users_provider ON USERS(PROVIDER);

-- 참고: UNIQUE 제약조건은 나중에 수동으로 추가
-- ALTER TABLE USERS ADD CONSTRAINT uk_users_kakao_id UNIQUE (KAKAO_ID); 


--

-- USER_DEVICE 테이블의 USER_ID 컬럼 타입 수정
-- 기존 테이블 삭제 후 재생성

-- 기존 외래키 제약조건 삭제
ALTER TABLE REFRESH_TOKEN DROP CONSTRAINT FK_REFRESH_TOKEN_USER_DEVICE;

-- 기존 USER_DEVICE 테이블 삭제
DROP TABLE USER_DEVICE;

-- 새로운 USER_DEVICE 테이블 생성
CREATE TABLE USER_DEVICE (
    ID NUMBER(20) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID VARCHAR2(50) NOT NULL,
    DEVICE_ID VARCHAR2(255) NOT NULL,
    DEVICE_TYPE VARCHAR2(20),
    NOTIFICATION_TOKEN VARCHAR2(255),
    IS_REFRESH_ACTIVE NUMBER(1) DEFAULT 1,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_USER_DEVICE_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
);

CREATE TABLE USER_DEVICE (
    ID NUMBER(20) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID VARCHAR2(50) NOT NULL,
    DEVICE_ID VARCHAR2(255) NOT NULL,
    DEVICE_TYPE VARCHAR2(20),
    NOTIFICATION_TOKEN VARCHAR2(255),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_USER_DEVICE_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
);

-- REFRESH_TOKEN 테이블의 외래키 제약조건 재생성
ALTER TABLE REFRESH_TOKEN ADD CONSTRAINT FK_REFRESH_TOKEN_USER_DEVICE 
    FOREIGN KEY (USER_DEVICE_ID) REFERENCES USER_DEVICE(ID); 